<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>CAMARA OBR v115 (MAX PERF)</title> 
    <link rel="icon" type="image/png" href="obr-logo.png">
    
    <!-- LIBS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection"></script>
    <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Orbitron:wght@500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        * { user-select: none; -webkit-touch-callout: none; box-sizing: border-box; outline: none; }
        
        /* FORZAR MODO HORIZONTAL (LANDSCAPE) SIEMPRE */
        body { 
            background: #000; overflow: hidden; 
            font-family: 'Orbitron', sans-serif; 
            width: 100vw; height: 100vh;
            margin: 0; padding: 0;
        }

        @media screen and (orientation: portrait) {
            body {
                transform: rotate(90deg);
                transform-origin: bottom left;
                position: absolute;
                top: -100vw;
                left: 0;
                height: 100vw;
                width: 100vh;
            }
        }
        
        /* CONTENEDOR DE CAPAS */
        #viewport { position: absolute; inset: 0; background: #000; overflow: hidden; }
        
        /* CAPA DE TRANSFORMACIÓN (ZOOM) */
        #zoom-layer { 
            position: absolute; inset: 0; width: 100%; height: 100%;
            transform-origin: center center; 
            transition: transform 0.2s ease-out; 
            will-change: transform;
        }

        /* VIDEO NATIVO (FONDO) */
        #video-source { 
            position: absolute; inset: 0; width: 100%; height: 100%; 
            object-fit: cover; z-index: 1; 
        }

        /* CANVAS SLS (ENCIMA) */
        #sls-canvas { 
            position: absolute; inset: 0; width: 100%; height: 100%; 
            object-fit: cover; z-index: 2; pointer-events: none; 
        }
        
        /* FILTROS CSS (APLICADOS AL VIDEO) */
        .filter-night { filter: grayscale(100%) sepia(100%) hue-rotate(90deg) contrast(1.2) brightness(1.3) saturate(1.2); }
        .filter-thermal { filter: invert(1) hue-rotate(180deg) contrast(1.2) saturate(1.2); }
        .filter-urbex { filter: sepia(30%) contrast(1.4) brightness(0.9) saturate(0.4); }
        
        /* UI LAYER (HUD) */
        #ui-layer { position: absolute; inset: 0; pointer-events: none; z-index: 20; }
        .interactive { pointer-events: auto; }
        
        /* TALLY LIGHT */
        #tally-border { 
            position: absolute; inset: 0; border: 0px solid transparent; 
            transition: border-width 0.2s; z-index: 50; pointer-events: none; 
        }
        #tally-border.program { border: 12px solid red; box-shadow: inset 0 0 40px red; }
        #tally-border.preview { border: 12px solid #00ff00; }

        /* MENUS LATERALES (ZONAS ACTIVAS) */
        .menu-container { 
            position: absolute; top: 50%; transform: translateY(-50%); 
            display: flex; flex-direction: column; gap: 15px; 
            z-index: 100; pointer-events: auto; 
            transition: opacity 0.2s; 
            opacity: 0; pointer-events: none; 
        }
        .menu-container.visible { opacity: 1; pointer-events: auto; }
        .menu-container.left-side { left: 20px; }
        .menu-container.right-side { right: 20px; }
        
        .menu-btn { 
            width: 55px; height: 55px; border: 2px solid #ff3333; border-radius: 50%; 
            background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; 
            color: #ff3333; font-size: 1.4rem; cursor: pointer; backdrop-filter: blur(4px);
            box-shadow: 0 0 15px rgba(0,0,0,0.5); active:scale-95 transition-transform;
        }
        .menu-btn.active { background: white; border-color: white; color: black; box-shadow: 0 0 20px white; }
        .menu-label { font-size: 0.6rem; color: white; text-align: center; margin-top: 4px; font-family: 'Share Tech Mono'; text-shadow: 1px 1px 2px black; background: rgba(0,0,0,0.6); padding: 1px 4px; border-radius: 4px; }

        /* LOADING */
        #loading { position: fixed; inset: 0; z-index: 200; background: black; display: flex; flex-direction: column; align-items: center; justify-content: center; background: radial-gradient(circle, #220000 0%, #000000 100%); }
        .load-btn { background: rgba(20,0,0,0.6); border: 2px solid #ff3333; color: #ff3333; padding: 18px 40px; font-size: 1.1rem; margin-top: 30px; cursor: pointer; font-weight: bold; clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px); transition: 0.2s; }
        .load-btn:hover { background: #ff3333; color: black; box-shadow: 0 0 30px #ff3333; }
        
        /* MODALS */
        .modal-bg { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 300; display: none; align-items: center; justify-content: center; pointer-events: auto; }
        .modal-bg.active { display: flex; }
        
        /* ZONA TÁCTIL TRANSPARENTE */
        #touch-surface { position: absolute; inset: 0; z-index: 15; pointer-events: auto; }
        
        #sls-pip { position: absolute; top: 15px; left: 50%; transform: translateX(-50%); color: #00ff00; font-family: 'Share Tech Mono'; font-size: 0.8rem; display: none; text-shadow: 0 0 5px #00ff00; background: rgba(0,0,0,0.6); padding: 2px 8px; border: 1px solid #00ff00; border-radius: 4px; }
    </style>
</head>
<body>

    <div id="viewport">
        <!-- CAPA DE ZOOM (VIDEO + SLS) -->
        <div id="zoom-layer">
            <video id="video-source" autoplay playsinline muted></video>
            <canvas id="sls-canvas"></canvas>
        </div>
    </div>

    <!-- SUPERFICIE TÁCTIL PARA ZOOM Y MENÚS -->
    <div id="touch-surface"></div>

    <div id="ui-layer">
        <div id="tally-border"></div>
        <div id="sls-pip">● SLS ACTIVO</div>
        
        <div id="link-status" class="absolute top-4 left-4 text-[10px] font-mono text-gray-400 bg-black/60 px-2 py-1 rounded border border-gray-800">OFFLINE</div>
        <div class="absolute top-4 right-4 interactive text-gray-500 cursor-pointer p-2 bg-black/30 rounded-full" onclick="openSettings()"><i class="fas fa-cog text-xl"></i></div>

        <!-- MENUS (DOBLE CLICK DESACTIVA) -->
        <div id="menu-left" class="menu-container left-side">
            <div><div class="menu-btn" onclick="setFilter('night', this)" ondblclick="setFilter('normal', null)"><i class="fas fa-moon"></i></div><div class="menu-label">NOCT</div></div>
            <div><div class="menu-btn" onclick="setFilter('thermal', this)" ondblclick="setFilter('normal', null)"><i class="fas fa-fire"></i></div><div class="menu-label">TERM</div></div>
            <div><div class="menu-btn" onclick="setFilter('urbex', this)" ondblclick="setFilter('normal', null)"><i class="fas fa-city"></i></div><div class="menu-label">URBEX</div></div>
            <div><div class="menu-btn" onclick="setFilter('sls', this)" ondblclick="setFilter('normal', null)"><i class="fas fa-ghost"></i></div><div class="menu-label">SLS</div></div>
        </div>

        <div id="menu-right" class="menu-container right-side">
            <div><div class="menu-btn" onclick="togglePareidolia()" ondblclick="togglePareidolia()" id="btn-ia"><i class="fas fa-eye"></i></div><div class="menu-label">VISION</div></div>
            <div><div class="menu-btn" onclick="openConnect()"><i class="fas fa-link"></i></div><div class="menu-label">LINK</div></div>
            <div><div class="menu-btn" onclick="resetZoom()"><i class="fas fa-compress"></i></div><div class="menu-label">RESET</div></div>
        </div>

        <!-- IA FEEDBACK -->
        <div id="ia-box" class="absolute bottom-6 right-6 bg-black/90 border border-red-500 p-3 hidden max-w-[200px] rounded shadow-lg shadow-red-900/20">
            <div id="ia-text" class="text-xs font-mono text-red-400 uppercase tracking-widest leading-relaxed"></div>
        </div>
    </div>

    <!-- PANTALLA CARGA -->
    <div id="loading">
        <h1 class="text-3xl text-red-600 font-bold mb-1 tracking-widest font-orbitron">OBR CAM</h1>
        <p class="text-xs font-mono text-gray-500 mb-8">MAX PERFORMANCE v115</p>
        <button class="load-btn" onclick="initApp()">INICIAR CÁMARA</button>
        <button id="pwa-btn" class="text-xs text-green-500 mt-6 border border-green-900 px-4 py-2 hidden interactive hover:bg-green-900/20" onclick="installPWA()">INSTALAR APP</button>
    </div>

    <!-- MODAL CONEXIÓN -->
    <div id="connect-modal" class="modal-bg">
        <div class="bg-neutral-900 border border-cyan-500 p-8 rounded-lg w-80 text-center shadow-[0_0_30px_rgba(0,255,255,0.1)]">
            <h3 class="text-cyan-400 mb-6 text-xl tracking-widest font-bold">ENLACE PRODOCK</h3>
            <input type="text" id="dock-id" placeholder="ID DEL DIRECTOR" class="w-full bg-black border border-gray-700 text-white p-4 text-center uppercase mb-6 text-xl outline-none focus:border-cyan-400 transition-colors rounded">
            <button onclick="connectToProdock()" class="w-full bg-cyan-900 text-white font-bold py-4 hover:bg-cyan-700 mb-4 rounded font-orbitron">CONECTAR</button>
            <button onclick="document.getElementById('connect-modal').classList.remove('active')" class="text-gray-500 text-xs hover:text-white">CANCELAR</button>
        </div>
    </div>

    <!-- MODAL AJUSTES -->
    <div id="settings-modal" class="modal-bg">
        <div class="bg-neutral-900 border border-red-900 p-6 rounded w-80 shadow-[0_0_30px_rgba(255,0,0,0.1)]">
            <h2 class="text-red-500 font-orbitron mb-4 font-bold">CONFIGURACIÓN</h2>
            <input type="password" id="api-key" placeholder="GEMINI API KEY" class="w-full bg-black border border-gray-700 p-3 text-white mb-6 text-sm rounded outline-none focus:border-red-500">
            <button onclick="saveSettings()" class="w-full border border-green-700 text-green-500 py-3 rounded hover:bg-green-900/20 font-bold">GUARDAR</button>
            <button onclick="document.getElementById('settings-modal').classList.remove('active')" class="w-full mt-3 text-gray-500 text-xs hover:text-white">CERRAR</button>
        </div>
    </div>

<script>
    // --- VARIABLES GLOBALES ---
    let API_KEY = localStorage.getItem("obr_key") || "";
    let currentFilter = 'normal';
    let isSLSActive = false;
    let isPareidoliaActive = false;
    let isAIWorking = false;
    let detector = null;
    let poses = [];
    let zoomLevel = 1;
    let peer, conn;
    let deferredPrompt;
    let menuTimer;
    let videoStream;

    const video = document.getElementById('video-source');
    const slsCanvas = document.getElementById('sls-canvas');
    const ctx = slsCanvas.getContext('2d');
    const zoomLayer = document.getElementById('zoom-layer');

    // --- INTERACCIÓN TÁCTIL (ZOOM A PUNTO + MENUS LATERALES) ---
    document.getElementById('touch-surface').addEventListener('click', (e) => {
        const w = window.innerWidth;
        const h = window.innerHeight;
        // Ajustamos coordenadas si está rotado por CSS (Portrait)
        // En Portrait, width y height se intercambian visualmente, pero clientX/Y siguen siendo de pantalla
        
        const touchX = e.clientX;
        const touchY = e.clientY;
        const edgeThreshold = 80; // Zona segura para menús (px)

        // 1. ZONA IZQUIERDA (MENÚ FILTROS)
        if (touchX < edgeThreshold) {
            showMenus();
            return;
        }

        // 2. ZONA DERECHA (MENÚ HERRAMIENTAS)
        if (touchX > w - edgeThreshold) {
            showMenus();
            return;
        }

        // 3. ZONA CENTRAL (ZOOM INTELIGENTE)
        // Zoom Toggle: 1x -> 2.5x -> 1x
        if (zoomLevel === 1) {
            zoomLevel = 2.5;
            // Calcular origen del zoom relativo al toque
            const originX = (touchX / w) * 100;
            const originY = (touchY / h) * 100;
            zoomLayer.style.transformOrigin = `${originX}% ${originY}%`;
            zoomLayer.style.transform = `scale(${zoomLevel})`;
        } else {
            resetZoom();
        }
    });

    function showMenus() {
        const left = document.getElementById('menu-left');
        const right = document.getElementById('menu-right');
        
        left.classList.add('visible');
        right.classList.add('visible');
        
        clearTimeout(menuTimer);
        menuTimer = setTimeout(() => {
            left.classList.remove('visible');
            right.classList.remove('visible');
        }, 4000);
    }

    function resetZoom() {
        zoomLevel = 1;
        zoomLayer.style.transform = `scale(1)`;
        // Reset origin to center smoothly
        setTimeout(() => {
            if(zoomLevel === 1) zoomLayer.style.transformOrigin = `center center`;
        }, 300);
    }

    // --- PWA ---
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault(); deferredPrompt = e;
        document.getElementById('pwa-btn').style.display = 'inline-block';
    });
    async function installPWA() { if(deferredPrompt) deferredPrompt.prompt(); }

    // --- INICIALIZACIÓN SISTEMA ---
    window.onload = () => document.getElementById('api-key').value = API_KEY;

    async function initApp() {
        const btn = document.querySelector('.load-btn');
        btn.innerText = "INICIANDO...";
        btn.disabled = true;
        
        try {
            // ARRANQUE PARALELO PARA VELOCIDAD
            const camPromise = navigator.mediaDevices.getUserMedia({ 
                audio: true, 
                video: { 
                    facingMode: 'environment', 
                    width: { ideal: 3840 }, // SOLICITAR 4K
                    height: { ideal: 2160 },
                    frameRate: { ideal: 60 },
                    advanced: [{ focusMode: "continuous" }] 
                } 
            });

            const aiPromise = tf.setBackend('webgl').then(() => 
                poseDetection.createDetector(poseDetection.SupportedModels.MoveNet, { 
                    modelType: poseDetection.movenet.modelType.MULTIPOSE_LIGHTNING 
                })
            );

            // Esperar ambos
            const [stream, det] = await Promise.all([camPromise, aiPromise]);
            
            videoStream = stream;
            video.srcObject = stream;
            detector = det;
            
            video.onloadedmetadata = () => { 
                video.play();
                document.getElementById('loading').style.display = 'none';
                resize(); 
                // BUCLE PRINCIPAL
                renderLoop(); 
                detectionLoop();
            };

            // Watchdog
            window.addEventListener('resize', resize);
            setInterval(() => { if (video.paused && video.srcObject) video.play().catch(()=>{}); }, 2000);
            
        } catch(e) { 
            alert("Error Inicio: " + e.message); 
            location.reload(); 
        }
    }

    function resize() { 
        slsCanvas.width = window.innerWidth; 
        slsCanvas.height = window.innerHeight; 
    }

    // --- RENDER LOOP OPTIMIZADO ---
    function renderLoop() {
        // Limpiar canvas de SLS (Transparente)
        ctx.clearRect(0, 0, slsCanvas.width, slsCanvas.height);
        
        // El video ya se muestra por debajo (capa 0).
        // Solo dibujamos SLS si es necesario
        if(isSLSActive && poses.length > 0) {
            drawSLS(poses);
        }
        
        requestAnimationFrame(renderLoop);
    }

    // --- DIBUJADO SLS (SILUETA ROJA + ESQUELETO) ---
    function drawSLS(poses) {
        ctx.lineJoin = 'round'; ctx.lineCap = 'round';
        
        poses.forEach(pose => {
            const k = pose.keypoints;
            const edges = [['nose','left_eye'],['nose','right_eye'],['left_eye','left_ear'],['right_eye','right_ear'],['left_shoulder','right_shoulder'],['left_shoulder','left_elbow'],['left_elbow','left_wrist'],['right_shoulder','right_elbow'],['right_elbow','right_wrist'],['left_shoulder','left_hip'],['right_shoulder','right_hip'],['left_hip','right_hip'],['left_hip','left_knee'],['left_knee','left_ankle'],['right_hip','right_knee'],['right_knee','right_ankle']];
            
            // 1. CAPA TÉRMICA (SILUETA ROJA GRUESA)
            ctx.shadowBlur = 30; 
            ctx.shadowColor = 'rgba(255, 0, 0, 0.8)'; 
            ctx.strokeStyle = 'rgba(255, 50, 50, 0.4)'; 
            ctx.lineWidth = 20; 
            
            ctx.beginPath();
            edges.forEach(([a,b]) => { 
                const p1=k.find(p=>p.name==a), p2=k.find(p=>p.name==b); 
                if(p1.score>0.15 && p2.score>0.15) { ctx.moveTo(p1.x,p1.y); ctx.lineTo(p2.x,p2.y); } 
            });
            ctx.stroke();
            
            // 2. ESQUELETO ESTRUCTURAL (VERDE)
            ctx.shadowBlur = 0; 
            ctx.strokeStyle = '#00ff00'; 
            ctx.lineWidth = 3;
            
            ctx.beginPath();
            edges.forEach(([a,b]) => { 
                const p1=k.find(p=>p.name==a), p2=k.find(p=>p.name==b); 
                if(p1.score>0.15 && p2.score>0.15) { ctx.moveTo(p1.x,p1.y); ctx.lineTo(p2.x,p2.y); } 
            });
            ctx.stroke();
        });
    }

    async function detectionLoop() {
        while(true) {
            // Solo detectar si es necesario (Ahorro de batería)
            if(detector && (isSLSActive || isPareidoliaActive)) {
                try { 
                    // Sensibilidad alta (0.15)
                    poses = await detector.estimatePoses(video, {maxPoses: 5, flipHorizontal: false, scoreThreshold: 0.15}); 
                } catch(e){}
            } else { poses = []; }
            
            // Intervalo de 50ms (20 FPS de detección es suficiente para fluidez visual)
            await new Promise(r => setTimeout(r, 50));
        }
    }

    // --- CONEXIÓN PEERJS ---
    function openConnect() { document.getElementById('connect-modal').classList.add('active'); }
    
    async function connectToProdock() {
        const id = document.getElementById('dock-id').value.trim();
        if(!id) return;
        document.getElementById('connect-modal').classList.remove('active');
        
        peer = new Peer();
        peer.on('open', myId => {
            conn = peer.connect(id);
            conn.on('open', () => {
                document.getElementById('link-status').innerText = "ONLINE: PRODOCK";
                document.getElementById('link-status').className = "absolute top-4 left-4 text-[10px] font-mono text-green-400 bg-green-900/40 px-2 py-1 rounded border border-green-500 font-bold";
                conn.send({ type: 'register', name: 'CAM-' + myId.substr(0,3) });
            });
            conn.on('data', d => {
                if(d.type === 'tally') document.getElementById('tally-border').className = d.state !== 'idle' ? d.state : '';
                if(d.type === 'cmd') handleCmd(d);
            });
            
            // ENVIAR STREAM (VIDEO DIRECTO PARA MAX CALIDAD)
            peer.call(id, videoStream);
        });
    }

    function handleCmd(d) {
        if(d.action === 'filter') setFilter(d.value); 
        if(d.action === 'toggle' && d.value === 'pareidolia') togglePareidolia();
        if(d.action === 'reset') { setFilter('normal'); resetZoom(); }
    }

    // --- ACCIONES DE CÁMARA ---
    function setFilter(f, btn) {
        // Toggle OFF si ya está activo
        if(currentFilter === f && f !== 'normal') {
            setFilter('normal');
            return;
        }

        currentFilter = f;
        isSLSActive = (f === 'sls');
        
        // UI
        document.querySelectorAll('.menu-btn').forEach(b => b.classList.remove('active'));
        if(btn && f !== 'normal') btn.classList.add('active');
        
        // Aplicar clase al video
        video.className = '';
        if(f === 'night') video.classList.add('filter-night');
        if(f === 'thermal') video.classList.add('filter-thermal');
        if(f === 'urbex') video.classList.add('filter-urbex');
        
        // Indicador SLS
        document.getElementById('sls-pip').style.display = isSLSActive ? 'block' : 'none';
    }

    async function togglePareidolia() {
        if(!API_KEY) return alert("FALTA API KEY (AJUSTES)");
        isPareidoliaActive = !isPareidoliaActive;
        const btn = document.getElementById('btn-ia');
        
        if(isPareidoliaActive) {
            btn.classList.add('active');
            analyzeAI();
        } else {
            btn.classList.remove('active');
            document.getElementById('ia-box').style.display = 'none';
        }
    }

    async function analyzeAI() {
        if(!isPareidoliaActive || isAIWorking) return;
        isAIWorking = true;
        
        // Capturar frame pequeño
        const c = document.createElement('canvas'); c.width=640; c.height=360;
        const cx = c.getContext('2d');
        // Dibujar con filtros si es necesario (aquí dibujamos raw)
        cx.drawImage(video,0,0,640,360);
        
        const b64 = c.toDataURL('image/jpeg', 0.5).split(',')[1];
        
        document.getElementById('ia-box').style.display = 'block';
        document.getElementById('ia-text').innerText = "ESCAN...";
        
        try {
            const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`, {
                method: 'POST', headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ contents: [{ parts: [{ text: "Describe en 3 palabras una amenaza paranormal. Sé breve." }, { inlineData: { mimeType: "image/jpeg", data: b64 } }] }] })
            });
            const d = await r.json();
            const txt = d.candidates?.[0]?.content?.parts?.[0]?.text || "...";
            document.getElementById('ia-text').innerText = txt;
            
            if('speechSynthesis' in window) {
                const u = new SpeechSynthesisUtterance(txt); u.lang='es-ES'; window.speechSynthesis.speak(u);
            }
        } catch(e) { console.log(e); }
        
        isAIWorking = false;
        if(isPareidoliaActive) setTimeout(analyzeAI, 8000);
    }

    function openSettings() { document.getElementById('settings-modal').classList.add('active'); }
    function saveSettings() {
        API_KEY = document.getElementById('api-key').value;
        localStorage.setItem("obr_key", API_KEY);
        document.getElementById('settings-modal').classList.remove('active');
    }
</script>
</body>
</html>
